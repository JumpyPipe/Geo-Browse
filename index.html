<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home Trends Dashboard</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 300px;
      background: #f4f4f4;
      padding: 1rem;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    #filters label {
      display: block;
      margin-bottom: 10px;
    }
    select {
      width: 100%;
      padding: 0.4rem;
      margin-top: 4px;
    }
    #map {
      flex-grow: 1;
    }
    #details {
      margin-top: 2rem;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    #loadingSpinner {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: bold;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

<div id="sidebar">
  <div id="filters">
    <label>ZIP Code:
      <select id="zipFilter"><option value="">View All</option></select>
    </label>
    <label>Style:
      <select id="styleFilter"><option value="">View All</option></select>
    </label>
    <label>Material:
      <select id="materialFilter"><option value="">View All</option></select>
    </label>
    <label>Color:
      <select id="colorFilter"><option value="">View All</option></select>
    </label>
    <label>Furniture Type:
      <select id="furnitureFilter"><option value="">View All</option></select>
    </label>
  </div>
  <div id="details"></div>
</div>

<div id="loadingSpinner">Loading Weather...</div>
<div id="map"></div>

<script>
  const map = L.map('map').setView([40.5, -118], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const zipFilter = document.getElementById('zipFilter');
  const styleFilter = document.getElementById('styleFilter');
  const materialFilter = document.getElementById('materialFilter');
  const colorFilter = document.getElementById('colorFilter');
  const furnitureFilter = document.getElementById('furnitureFilter');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const detailBox = document.getElementById('details');

  let allFeatures = [];
  let geojsonLayer;

  async function getWeatherData(zip) {
    const apiKey = '7746c66eda7c6242b2e70c4e7f132d62';
    const url = `https://api.openweathermap.org/data/2.5/weather?zip=${zip},US&appid=${apiKey}&units=imperial`;
    try {
      const res = await fetch(url);
      const data = await res.json();
      if (data.cod === 200) {
        return {
          tempF: data.main.temp,
          tempC: ((data.main.temp - 32) * 5 / 9).toFixed(1),
          precipitation: data.weather[0].main.includes("Rain") ? "Yes" : "No"
        };
      }
    } catch (error) {
      console.error(`Weather fetch failed for ${zip}:`, error);
    }
    return null;
  }

  function styleFeature(feature) {
    return {
      color: "#3388ff",
      weight: 1,
      fillOpacity: 0.0
    };
  }

  function highlightFeature(feature) {
    return {
      color: "#3388ff",
      weight: 1,
      fillOpacity: 0.4
    };
  }

  function displayDetails(p, weather) {
    const demo = p.Demographics || {};
    const house = p.Housing || {};
    detailBox.innerHTML = `
      <b>ZIP:</b> ${p.zip}<br/><hr>
      <b>Furniture Preference</b><br/>
      <b>Furniture:</b> ${p.Furniture_Type || 'N/A'}<br/>
      <b>Style:</b> ${p.Style || 'N/A'}<br/>
      <b>Material:</b> ${p.Primary_Material || 'N/A'}<br/>
      <b>Color:</b> ${p.Color || 'N/A'}<br/>
      <b>Price Point:</b> ${p.Price_Point || 'N/A'}<br/>
      <b>Pattern:</b> ${p.Pattern || 'N/A'}<br/><hr>
      <b>Demographics</b><br/>
      <b>Median Income:</b> $${demo.Median_Household_Income?.toLocaleString() || 'N/A'}<br/>
      <b>Median Home Value:</b> $${demo.Median_Home_Value?.toLocaleString() || 'N/A'}<br/>
      <b>Median Age:</b> ${demo.Median_Age || 'N/A'}<br/>
      <b>Race:</b> ${demo.Racial_Composition || 'N/A'}<br/>
      <b>Education:</b> ${demo.Education || 'N/A'}<br/><hr>
      <b>Housing</b><br/>
      <b>Home Type:</b> ${house.Dominant_Home_Type || 'N/A'}<br/>
      <b>Avg Sq Ft:</b> ${house.Average_Home_Size_SqFt || 'N/A'}<br/>
      <b>Age of Home:</b> ${house.Median_Year_Built || 'N/A'}<br/>
      <b>Architectural Style:</b> ${house.Architectural_Style || 'N/A'}<br/><hr>
      <b>Current Weather</b><br/>
      <b>Temp:</b> ${weather ? `${weather.tempF}°F / ${weather.tempC}°C` : 'N/A'}<br/>
      <b>Precipitation:</b> ${weather ? weather.precipitation : 'N/A'}<br/><br/>
      <i>${p.Rationale || ''}</i>
    `;
  }

  function updateMap() {
    const zipVal = zipFilter.value.trim();
    const styleVal = styleFilter.value.trim();
    const materialVal = materialFilter.value.trim();
    const colorVal = colorFilter.value.trim();
    const furnitureVal = furnitureFilter.value.trim();

    if (geojsonLayer) geojsonLayer.remove();

    const filtered = allFeatures.filter(f => {
      const p = f.properties;
      return (!zipVal || p.zip === zipVal)
        && (!styleVal || p.Style === styleVal)
        && (!materialVal || p.Primary_Material === materialVal)
        && (!colorVal || p.Color === colorVal)
        && (!furnitureVal || p.Furniture_Type === furnitureVal);
    });

    geojsonLayer = L.geoJSON(filtered, {
      style: f => (zipVal || styleVal || materialVal || colorVal || furnitureVal ? highlightFeature(f) : styleFeature(f)),
      onEachFeature: (feature, layer) => {
        layer.on('click', () => {
          loadingSpinner.style.display = 'block';
          getWeatherData(feature.properties.zip).then(weather => {
            displayDetails(feature.properties, weather);
            loadingSpinner.style.display = 'none';
          });
        });
      }
    }).addTo(map);

    if (filtered.length > 0) {
      map.fitBounds(geojsonLayer.getBounds());
    }
  }
</script>
</body>
</html>
